<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Play | Panhandle Math League</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Archivo+Black&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,700&display=swap"
        rel="stylesheet">

    <style>
        :root {
            --bg-color: #faf8f5;
            --card-bg: #ffffff;
            --midnight: #0a1628;
            --deep-blue: #1a2744;
            --gold: #f7b32b;
            --gold-light: #ffd06a;
            --gold-dark: #c48a1a;
            --rust: #c45c26;
            --sky: #4a9eff;
            --success: #22c55e;
            --error: #ef4444;
            --text-primary: #0a1628;
            --text-secondary: #5a6a7a;
            --slot-bg: #f1f5f9;
            --slot-border: #e2e8f0;
        }

        [data-theme="dark"] {
            --bg-color: #0a1628;
            --card-bg: #1a2744;
            --text-primary: #faf8f5;
            --text-secondary: #94a3b8;
            --slot-bg: #1e3a5f;
            --slot-border: #2d4a6f;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: 16px;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-primary);
            margin: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
            touch-action: manipulation;
            overscroll-behavior: none;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Header */
        header {
            width: 100%;
            padding: 12px 20px;
            background: var(--midnight);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: var(--gold);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: 'Archivo Black', sans-serif;
            font-size: 1rem;
            color: var(--midnight);
            transform: rotate(-3deg);
        }

        .logo-text {
            font-family: 'Archivo Black', sans-serif;
            font-size: 0.9rem;
        }

        .theme-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.2s;
        }

        .theme-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .header-stats {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .stat-box {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            font-weight: 600;
        }

        .stat-box.progress {
            color: var(--gold);
        }

        .play-btn {
            padding: 1rem 3rem;
            font-size: 1.25rem;
            font-weight: 700;
            font-family: 'Archivo Black', sans-serif;
            background: var(--gold);
            color: var(--midnight);
            border: none;
            border-radius: 12px;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--gold-dark);
            transition: all 0.1s;
        }

        .play-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 0 var(--gold-dark);
        }

        .play-btn:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 var(--gold-dark);
        }

        /* Game Container */
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 900px;
            width: 100%;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Level Select */
        .level-select {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            margin-bottom: 1rem;
        }

        .level-btn {
            background: var(--card-bg);
            border: 2px solid var(--slot-border);
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-secondary);
            transition: 0.2s;
        }

        .level-btn:hover {
            border-color: var(--gold);
            color: var(--text-primary);
        }

        .level-btn.selected {
            background: var(--gold);
            border-color: var(--gold);
            color: var(--midnight);
        }

        /* Problem Display */
        .problem-area {
            background: var(--slot-bg);
            border: 2px solid var(--slot-border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .slots-wrapper {
            display: flex;
            justify-content: center;
            gap: 1.5rem;
            flex-wrap: wrap;
        }

        .slot-group-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .group-header {
            font-weight: 700;
            color: var(--deep-blue);
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        [data-theme="dark"] .group-header {
            color: var(--gold);
        }

        .slot-group {
            display: flex;
            gap: 12px;
        }

        .card {
            background: var(--card-bg);
            border-radius: 12px;
            width: 100px;
            height: 110px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 3px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .card label {
            font-size: 0.65rem;
            text-transform: uppercase;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-weight: 600;
        }

        .card input {
            width: 95%;
            border: none;
            text-align: center;
            font-weight: 700;
            font-family: 'Archivo Black', sans-serif;
            color: var(--text-primary);
            background: transparent;
            outline: none;
            pointer-events: none;
            padding: 0;
            margin: 0;
            /* Default size for 1-2 chars */
            font-size: 2.2rem;
        }

        /* Auto-size classes based on character count */
        .card input.chars-1 { font-size: 2.4rem; }
        .card input.chars-2 { font-size: 2.2rem; }
        .card input.chars-3 { font-size: 1.6rem; }
        .card input.chars-4 { font-size: 1.3rem; }

        .card.active {
            border-color: var(--gold);
            background: linear-gradient(135deg, rgba(247, 179, 43, 0.1), rgba(247, 179, 43, 0.05));
            transform: translateY(-2px);
        }

        .card.locked {
            background: var(--slot-bg);
        }

        .card.correct-answer {
            background: var(--success);
            border-color: var(--success);
        }

        .card.correct-answer input {
            color: white;
        }

        .card.wrong {
            animation: shake 0.4s ease;
            border-color: var(--error);
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            20%,
            60% {
                transform: translateX(-8px);
            }

            40%,
            80% {
                transform: translateX(8px);
            }
        }

        /* Message Area */
        .message-area {
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 0.5rem;
        }

        .msg {
            font-weight: 700;
            font-size: 1rem;
        }

        .msg.success {
            color: var(--success);
        }

        .msg.error {
            color: var(--error);
        }

        /* Keypad */
        .keypad-area {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex: 1;
            margin-bottom: 1rem;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            flex: 1;
            max-width: 400px;
        }

        .key {
            width: 100%;
            height: 100%;
            min-height: 60px;
            background: var(--gold);
            border: none;
            border-radius: 12px;
            font-size: clamp(1.5rem, 5vw, 2.2rem);
            font-weight: 700;
            font-family: 'Archivo Black', sans-serif;
            cursor: pointer;
            box-shadow: 0 4px 0 var(--gold-dark);
            color: var(--midnight);
            transition: transform 0.1s;
        }

        .key:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 var(--gold-dark);
        }

        .key.action {
            background: var(--sky);
            box-shadow: 0 4px 0 #2563eb;
            color: white;
        }

        .key.delete {
            background: var(--error);
            box-shadow: 0 4px 0 #b91c1c;
            color: white;
        }

        /* Bottom Actions */
        .bottom-actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 1rem;
        }

        .action-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .btn-skip {
            background: var(--text-secondary);
            color: white;
        }

        .btn-reset {
            background: var(--rust);
            color: white;
        }

        .btn-reset:hover,
        .btn-skip:hover {
            opacity: 0.9;
        }

        /* End Game Modal */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 22, 40, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 1rem;
        }

        .overlay.active {
            display: flex;
        }

        .modal {
            background: var(--card-bg);
            border-radius: 20px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
            text-align: center;
        }

        .modal h2 {
            font-family: 'Archivo Black', sans-serif;
            color: var(--midnight);
            margin-bottom: 1.5rem;
        }

        [data-theme="dark"] .modal h2 {
            color: var(--gold);
        }

        .end-time {
            font-family: 'Archivo Black', sans-serif;
            font-size: 3rem;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .end-saying {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        /* Mobile Responsive */
        @media (max-width: 600px) {
            header {
                padding: 10px 12px;
            }

            .logo-text {
                display: none;
            }

            .stat-box {
                padding: 4px 8px;
                font-size: 0.85rem;
            }

            .game-container {
                padding: 0.5rem;
            }

            .problem-area {
                padding: 0.75rem;
                margin-bottom: 0.5rem;
            }

            .card {
                width: 22vw;
                min-width: 70px;
                max-width: 90px;
                height: 80px;
            }

            .card input {
                font-size: 1.8rem;
            }

            .card input.chars-1 { font-size: 2rem; }
            .card input.chars-2 { font-size: 1.8rem; }
            .card input.chars-3 { font-size: 1.3rem; }
            .card input.chars-4 { font-size: 1.05rem; }

            .keypad-area {
                flex: 1;
                margin-bottom: 0.5rem;
            }

            .keypad {
                gap: 6px;
                max-width: 100%;
            }

            .key {
                min-height: 50px;
                border-radius: 10px;
            }

            .level-btn {
                font-size: 0.7rem;
                padding: 6px 10px;
            }

            .level-select {
                margin-bottom: 0.5rem;
            }

            .message-area {
                height: 24px;
                margin-bottom: 0.25rem;
            }

            .bottom-actions {
                margin-bottom: 0.5rem;
            }

            .action-btn {
                padding: 10px 20px;
                font-size: 0.85rem;
            }
        }
    </style>
</head>

<body>

    <!-- Header -->
    <header>
        <div class="header-left">
            <a href="index.html" class="logo">
                <div class="logo-icon">Œ£</div>
                <span class="logo-text">Mathematician</span>
            </a>
            <button onclick="toggleTheme()" class="theme-btn" title="Toggle Theme">üåó</button>
        </div>
        <div class="header-stats">
            <div class="stat-box" id="timerBox">‚è± 0:00</div>
            <div class="stat-box progress" id="progressBox">0/10</div>
        </div>
    </header>

    <!-- Game Container -->
    <div class="game-container" id="gameContainer">

        <!-- Level Select -->
        <div class="level-select" id="levelSelector">
            <button class="level-btn selected" onclick="game.setLevel(1)">Sum/Product (¬±10)</button>
            <button class="level-btn" onclick="game.setLevel(2)">Sum/Product (¬±15)</button>
            <button class="level-btn" onclick="game.setLevel(3)">Find Integers (¬±10)</button>
            <button class="level-btn" onclick="game.setLevel(4)">Find Integers (¬±15)</button>
            <button class="level-btn" onclick="game.setLevel(5)">Random Mix (¬±10)</button>
            <button class="level-btn" onclick="game.setLevel(6)">Random Mix (¬±15)</button>
        </div>

        <!-- Problem Area -->
        <div class="problem-area">
            <div class="slots-wrapper">
                <div class="slot-group-container">
                    <div class="group-header">Integers</div>
                    <div class="slot-group">
                        <div class="card" id="card-i1" onclick="game.setActiveInput('i1')">
                            <label>Int 1</label>
                            <input type="text" id="input-i1" readonly>
                        </div>
                        <div class="card" id="card-i2" onclick="game.setActiveInput('i2')">
                            <label>Int 2</label>
                            <input type="text" id="input-i2" readonly>
                        </div>
                    </div>
                </div>
                <div class="slot-group-container">
                    <div class="group-header">Results</div>
                    <div class="slot-group">
                        <div class="card" id="card-sum" onclick="game.setActiveInput('sum')">
                            <label>Sum</label>
                            <input type="text" id="input-sum" readonly>
                        </div>
                        <div class="card" id="card-prod" onclick="game.setActiveInput('prod')">
                            <label>Product</label>
                            <input type="text" id="input-prod" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Message Area -->
        <div class="message-area">
            <div class="msg" id="messageBox"></div>
        </div>

        <!-- Keypad -->
        <div class="keypad-area">
            <div class="keypad">
                <button class="key" onclick="game.typeNum(7)">7</button>
                <button class="key" onclick="game.typeNum(8)">8</button>
                <button class="key" onclick="game.typeNum(9)">9</button>
                <button class="key" onclick="game.typeNum(4)">4</button>
                <button class="key" onclick="game.typeNum(5)">5</button>
                <button class="key" onclick="game.typeNum(6)">6</button>
                <button class="key" onclick="game.typeNum(1)">1</button>
                <button class="key" onclick="game.typeNum(2)">2</button>
                <button class="key" onclick="game.typeNum(3)">3</button>
                <button class="key action" onclick="game.typeNum('-')">‚àí</button>
                <button class="key" onclick="game.typeNum(0)">0</button>
                <button class="key delete" onclick="game.backspace()">‚å´</button>
            </div>
        </div>

        <!-- Bottom Actions -->
        <div class="bottom-actions">
            <button class="action-btn btn-reset" onclick="game.resetGame()">New Game</button>
            <button class="action-btn btn-skip" onclick="game.skipProblem()">Skip ‚Üí</button>
        </div>
    </div>

    <!-- End Game Modal -->
    <div class="overlay" id="endModal">
        <div class="modal">
            <h2 id="endTitle">Round Complete!</h2>
            <div class="end-level" id="endLevel" style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.5rem;"></div>
            <div class="end-time" id="finalTime">0:00</div>
            <div class="end-saying" id="endSaying"></div>
            <button class="play-btn" onclick="game.resetGame()">Play Again</button>
        </div>
    </div>

    <script>
        class MathGame {
            constructor() {
                this.level = 1;
                this.isPlaying = false;
                this.timerInterval = null;
                this.currentProblem = {};
                this.activeFieldId = null;
                this.questionsAnswered = 0;
                this.questionsToSolve = 10;

                this.levelConfig = {
                    1: { range: 10, mode: 'find_results' },
                    2: { range: 15, mode: 'find_results' },
                    3: { range: 10, mode: 'find_integers' },
                    4: { range: 15, mode: 'find_integers' },
                    5: { range: 10, mode: 'random' },
                    6: { range: 15, mode: 'random' }
                };

                this.init();
            }

            init() {
                this.resetGame();
            }

            setLevel(lvl) {
                this.level = lvl;
                document.querySelectorAll('.level-btn').forEach((btn, idx) => {
                    btn.classList.toggle('selected', idx + 1 === lvl);
                });
                if (this.isPlaying) {
                    this.generateProblem();
                }
            }

            resetGame() {
                clearInterval(this.timerInterval);
                this.questionsAnswered = 0;
                this.isPlaying = true;
                this.elapsedTime = 0;

                document.getElementById('progressBox').textContent = `0/${this.questionsToSolve}`;
                document.getElementById('endModal').classList.remove('active');
                document.getElementById('messageBox').textContent = '';

                this.startTimer();
                this.generateProblem();
            }

            startTimer() {
                this.updateTimerDisplay();
                this.timerInterval = setInterval(() => {
                    this.elapsedTime++;
                    this.updateTimerDisplay();
                }, 1000);
            }

            updateTimerDisplay() {
                const m = Math.floor(this.elapsedTime / 60);
                const s = this.elapsedTime % 60;
                document.getElementById('timerBox').textContent = `‚è± ${m}:${s < 10 ? '0' + s : s}`;
            }

            generateProblem() {
                const config = this.levelConfig[this.level];
                let i1, i2;

                // Never allow zero for integers (only sum can be zero)
                do {
                    i1 = Math.floor(Math.random() * (config.range * 2 + 1)) - config.range;
                } while (i1 === 0);

                do {
                    i2 = Math.floor(Math.random() * (config.range * 2 + 1)) - config.range;
                } while (i2 === 0);

                const sum = i1 + i2;
                const prod = i1 * i2;

                this.currentProblem = { i1, i2, sum, prod };

                let toHide = [];
                if (config.mode === 'find_results') {
                    toHide = ['sum', 'prod'];
                } else if (config.mode === 'find_integers') {
                    toHide = ['i1', 'i2'];
                } else if (config.mode === 'random') {
                    const options = ['i1', 'i2', 'sum', 'prod'];
                    const shuffled = options.sort(() => 0.5 - Math.random());
                    toHide = [shuffled[0], shuffled[1]];
                }

                this.currentProblem.hiddenFields = toHide;
                this.renderBoard();
            }

            renderBoard() {
                const fields = ['i1', 'i2', 'sum', 'prod'];
                let firstHidden = null;

                fields.forEach(field => {
                    const input = document.getElementById(`input-${field}`);
                    const card = document.getElementById(`card-${field}`);

                    input.value = '';
                    input.classList.remove('chars-1', 'chars-2', 'chars-3', 'chars-4');
                    card.classList.remove('active', 'locked', 'correct-answer', 'wrong');

                    if (this.currentProblem.hiddenFields.includes(field)) {
                        if (!firstHidden) firstHidden = field;
                    } else {
                        input.value = this.currentProblem[field];
                        card.classList.add('locked');
                        this.updateInputSize(input);
                    }
                });

                if (firstHidden) {
                    this.setActiveInput(firstHidden);
                }

                document.getElementById('messageBox').textContent = '';
            }

            setActiveInput(fieldId) {
                if (!this.isPlaying) return;
                if (!this.currentProblem.hiddenFields.includes(fieldId)) return;

                document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
                this.activeFieldId = fieldId;
                document.getElementById(`card-${fieldId}`).classList.add('active');
            }

            switchActiveInput() {
                if (!this.isPlaying) return;
                const hidden = this.currentProblem.hiddenFields;
                if (!hidden || hidden.length < 2) return;

                let currentIdx = hidden.indexOf(this.activeFieldId);
                const nextIdx = (currentIdx + 1) % hidden.length;
                this.setActiveInput(hidden[nextIdx]);
            }

            typeNum(val) {
                if (!this.activeFieldId || !this.isPlaying) return;
                const input = document.getElementById(`input-${this.activeFieldId}`);

                if (val === '-' && input.value.includes('-')) return;
                if (val === '-' && input.value.length > 0) return;
                if (input.value.length >= 4) return;

                input.value += val;
                this.updateInputSize(input);
                this.haptic();

                // Auto-check after typing
                this.autoCheckField();
            }

            autoCheckField() {
                if (!this.isPlaying || !this.activeFieldId) return;

                const hidden = this.currentProblem.hiddenFields;
                const currentField = this.activeFieldId;
                const input = document.getElementById(`input-${currentField}`);
                const userVal = parseInt(input.value);

                // Don't check if input is empty or just a minus sign
                if (input.value === '' || input.value === '-' || isNaN(userVal)) return;

                // Update font size class
                this.updateInputSize(input);

                // For find_integers mode (both i1 and i2 hidden)
                if (hidden.includes('i1') && hidden.includes('i2')) {
                    const a1 = this.currentProblem.i1;
                    const a2 = this.currentProblem.i2;

                    // Check if the current value matches either correct integer
                    if (userVal === a1 || userVal === a2) {
                        document.getElementById(`card-${currentField}`).classList.add('correct-answer');
                        this.haptic();

                        // Check the other field
                        const otherField = currentField === 'i1' ? 'i2' : 'i1';
                        const otherCard = document.getElementById(`card-${otherField}`);
                        const otherInput = document.getElementById(`input-${otherField}`);
                        const otherVal = parseInt(otherInput.value);

                        if (otherCard.classList.contains('correct-answer') && !isNaN(otherVal)) {
                            // Both fields filled and green - verify the pair
                            const correctPair = [a1, a2].sort((a, b) => a - b);
                            const userPair = [userVal, otherVal].sort((a, b) => a - b);

                            if (correctPair[0] === userPair[0] && correctPair[1] === userPair[1]) {
                                this.handleCorrectAnswer(hidden);
                            }
                        } else {
                            // Switch to the other field
                            this.setActiveInput(otherField);
                        }
                    }
                    return;
                }

                // For other modes, check individual field
                const correctVal = this.currentProblem[currentField];

                if (userVal === correctVal) {
                    // This field is correct - mark it green
                    document.getElementById(`card-${currentField}`).classList.add('correct-answer');
                    this.haptic();

                    // Find next unanswered hidden field
                    const otherFields = hidden.filter(f => f !== currentField);
                    const unansweredFields = otherFields.filter(f => {
                        const card = document.getElementById(`card-${f}`);
                        return !card.classList.contains('correct-answer');
                    });

                    if (unansweredFields.length > 0) {
                        // Switch to next field
                        this.setActiveInput(unansweredFields[0]);
                    } else {
                        // All fields answered correctly
                        this.handleCorrectAnswer(hidden);
                    }
                }
            }

            updateInputSize(input) {
                input.classList.remove('chars-1', 'chars-2', 'chars-3', 'chars-4');
                const len = input.value.length;
                if (len >= 4) input.classList.add('chars-4');
                else if (len === 3) input.classList.add('chars-3');
                else if (len === 2) input.classList.add('chars-2');
                else if (len === 1) input.classList.add('chars-1');
            }

            haptic() {
                if (navigator.vibrate) {
                    navigator.vibrate(10);
                }
            }

            backspace() {
                if (!this.activeFieldId || !this.isPlaying) return;
                const input = document.getElementById(`input-${this.activeFieldId}`);
                input.value = input.value.slice(0, -1);
                this.updateInputSize(input);
                this.haptic();
            }

            checkAnswer() {
                if (!this.isPlaying) return;

                const hidden = this.currentProblem.hiddenFields;

                // Check if we're in partial-check mode (one field at a time)
                // For find_integers mode, we check both at once (order doesn't matter)
                if (hidden.includes('i1') && hidden.includes('i2')) {
                    // Check both integers together
                    const userI1 = parseInt(document.getElementById('input-i1').value);
                    const userI2 = parseInt(document.getElementById('input-i2').value);

                    const correctPair = [this.currentProblem.i1, this.currentProblem.i2].sort((a, b) => a - b);
                    const userPair = [userI1, userI2].sort((a, b) => a - b);

                    const allCorrect = (correctPair[0] === userPair[0] && correctPair[1] === userPair[1]);

                    if (allCorrect) {
                        this.handleCorrectAnswer(hidden);
                    } else {
                        this.handleWrongAnswer(hidden);
                    }
                } else {
                    // Check fields one at a time and auto-switch
                    const currentField = this.activeFieldId;
                    const userVal = parseInt(document.getElementById(`input-${currentField}`).value);
                    const correctVal = this.currentProblem[currentField];

                    if (userVal === correctVal) {
                        // This field is correct - mark it green
                        document.getElementById(`card-${currentField}`).classList.add('correct-answer');
                        this.haptic();

                        // Find next unanswered hidden field
                        const otherFields = hidden.filter(f => f !== currentField);
                        const unansweredFields = otherFields.filter(f => {
                            const card = document.getElementById(`card-${f}`);
                            return !card.classList.contains('correct-answer');
                        });

                        if (unansweredFields.length > 0) {
                            // Switch to next field
                            this.setActiveInput(unansweredFields[0]);
                        } else {
                            // All fields answered correctly
                            this.handleCorrectAnswer(hidden);
                        }
                    } else {
                        this.handleWrongAnswer(hidden);
                    }
                }
            }

            handleCorrectAnswer(hidden) {
                this.questionsAnswered++;

                // Update progress display
                document.getElementById('progressBox').textContent = `${this.questionsAnswered}/${this.questionsToSolve}`;

                // Visual feedback - mark all hidden fields as correct
                hidden.forEach(field => {
                    document.getElementById(`card-${field}`).classList.add('correct-answer');
                });

                document.getElementById('messageBox').textContent = 'Correct!';
                document.getElementById('messageBox').className = 'msg success';

                this.haptic();

                // Check if game over
                if (this.questionsAnswered >= this.questionsToSolve) {
                    setTimeout(() => this.endGame(), 500);
                } else {
                    setTimeout(() => {
                        hidden.forEach(field => {
                            document.getElementById(`card-${field}`).classList.remove('correct-answer');
                        });
                        this.generateProblem();
                    }, 400);
                }
            }

            handleWrongAnswer(hidden) {
                document.getElementById('messageBox').textContent = 'Try Again!';
                document.getElementById('messageBox').className = 'msg error';

                // Shake animation
                hidden.forEach(field => {
                    const card = document.getElementById(`card-${field}`);
                    card.classList.add('wrong');
                    setTimeout(() => card.classList.remove('wrong'), 400);
                });
            }

            skipProblem() {
                if (!this.isPlaying) return;
                this.generateProblem();
                document.getElementById('messageBox').textContent = 'Skipped';
                document.getElementById('messageBox').className = 'msg';
            }

            getTimeSaying(seconds) {
                if (seconds < 20) return "Unbelievable! You're a math machine!";
                if (seconds < 30) return "Blazing fast! That was incredible!";
                if (seconds < 45) return "Impressive speed! You really know your stuff!";
                if (seconds < 60) return "Under a minute! Great job!";
                if (seconds < 90) return "Solid work! You're getting faster!";
                if (seconds < 120) return "Nice effort! Keep practicing to break a minute!";
                if (seconds < 180) return "Good start! Practice makes perfect!";
                return "You finished! Try again to beat your time!";
            }

            endGame() {
                this.isPlaying = false;
                clearInterval(this.timerInterval);

                const m = Math.floor(this.elapsedTime / 60);
                const s = this.elapsedTime % 60;
                const finalTimeStr = `${m}:${s < 10 ? '0' + s : s}`;

                const levelNames = {
                    1: 'Sum/Product (¬±10)',
                    2: 'Sum/Product (¬±15)',
                    3: 'Find Integers (¬±10)',
                    4: 'Find Integers (¬±15)',
                    5: 'Random Mix (¬±10)',
                    6: 'Random Mix (¬±15)'
                };

                document.getElementById('endLevel').textContent = levelNames[this.level];
                document.getElementById('finalTime').textContent = finalTimeStr;
                document.getElementById('endSaying').textContent = this.getTimeSaying(this.elapsedTime);

                document.getElementById('endModal').classList.add('active');
            }
        }

        // Initialize game
        window.game = new MathGame();

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            document.body.setAttribute('data-theme', current === 'dark' ? 'light' : 'dark');
        }

        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (!window.game || !window.game.isPlaying) return;

            if (e.key >= '0' && e.key <= '9') {
                game.typeNum(e.key);
                return;
            }
            if (e.key === '-' || e.key === '_') {
                game.typeNum('-');
                return;
            }
            if (e.key === 'Backspace' || e.key === 'Delete') {
                game.backspace();
                return;
            }
            if (e.key === 'Enter' || e.key === '=') {
                e.preventDefault();
                game.checkAnswer();
                return;
            }
            if (e.key === 'Tab' || e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                e.preventDefault();
                game.switchActiveInput();
            }
            if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                e.preventDefault();
                game.switchActiveInput();
            }
        });
    </script>

</body>

</html>